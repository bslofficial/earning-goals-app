<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ProEarn - Admin Panel</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .admin-card { background: #1a1f2e; border-radius: 15px; padding: 20px; margin-bottom: 20px; border: 1px solid #3b82f6; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 13px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #2d3748; }
        th { color: #3b82f6; text-transform: uppercase; }
        .status-btn { padding: 5px 10px; border-radius: 5px; border: none; cursor: pointer; font-weight: bold; font-size: 11px; }
        .pay-btn { background: #10b981; color: white; }
        .del-btn { background: #ef4444; color: white; margin-left: 5px; }
        .tab-btn { padding: 10px 20px; background: #0b0e14; color: white; border: 1px solid #3b82f6; cursor: pointer; border-radius: 8px; margin-right: 10px; }
        .tab-btn.active { background: #3b82f6; }
    </style>
</head>
<body>

    <div class="app-container" style="max-width: 800px;">
        <div class="top-nav-blue">
            <h1 class="app-title-header">ADMIN DASHBOARD</h1>
            <p>Manage Users & Payments</p>
        </div>

        <div class="main-content">
            <div style="margin-bottom: 20px;">
                <button class="tab-btn active" onclick="showTab('users')">Users List</button>
                <button class="tab-btn" onclick="showTab('withdraws')">Withdraw Requests</button>
            </div>

            <div id="users-sec" class="admin-card">
                <h3>Total Users</h3>
                <div id="user-table-container" style="overflow-x: auto;">
                    <table>
                        <thead>
                            <tr>
                                <th>Email</th>
                                <th>Balance</th>
                                <th>Tasks</th>
                            </tr>
                        </thead>
                        <tbody id="user-list"></tbody>
                    </table>
                </div>
            </div>

            <div id="withdraws-sec" class="admin-card" style="display: none;">
                <h3>Pending Withdrawals</h3>
                <div style="overflow-x: auto;">
                    <table>
                        <thead>
                            <tr>
                                <th>User ID</th>
                                <th>Method</th>
                                <th>Account</th>
                                <th>Amount</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="withdraw-list"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.10.0/firebase-app.js";
        import { getDatabase, ref, get, update, remove } from "https://www.gstatic.com/firebasejs/12.10.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDuLLapNwRk2Fl5rN6F0ezZb9KsMBKhvqA",
            authDomain: "earning-goals-app.firebaseapp.com",
            projectId: "earning-goals-app",
            databaseURL: "https://earning-goals-app-default-rtdb.firebaseio.com", // আপনার ডাটাবেস URL নিশ্চিত করুন
            storageBucket: "earning-goals-app.firebasestorage.app",
            messagingSenderId: "999611133128",
            appId: "1:999611133128:web:f8bd2cb60ac5a07b1249fd"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // Tab Switcher
        window.showTab = (tab) => {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            if(tab === 'users'){
                document.getElementById('users-sec').style.display = 'block';
                document.getElementById('withdraws-sec').style.display = 'none';
            } else {
                document.getElementById('users-sec').style.display = 'none';
                document.getElementById('withdraws-sec').style.display = 'block';
            }
        };

        // Load Users
        async function loadUsers() {
            const snap = await get(ref(db, 'users'));
            const list = document.getElementById('user-list');
            list.innerHTML = "";
            snap.forEach(child => {
                const u = child.val();
                list.innerHTML += `<tr>
                    <td>${u.email || 'N/A'}</td>
                    <td>Tk.${(u.balance || 0).toFixed(2)}</td>
                    <td>${u.totalTaskCount || 0}</td>
                </tr>`;
            });
        }

        // Load Withdraws
        async function loadWithdraws() {
            const snap = await get(ref(db, 'withdrawals'));
            const list = document.getElementById('withdraw-list');
            list.innerHTML = "";
            snap.forEach(userNode => {
                const userId = userNode.key;
                userNode.forEach(withdrawNode => {
                    const w = withdrawNode.val();
                    const wId = withdrawNode.key;
                    if(w.status === "Pending"){
                        list.innerHTML += `<tr>
                            <td>${userId.substring(0,5)}...</td>
                            <td>${w.method}</td>
                            <td>${w.accountNo}</td>
                            <td>Tk.${w.amount}</td>
                            <td>
                                <button class="status-btn pay-btn" onclick="approveWithdraw('${userId}', '${wId}')">Approve</button>
                                <button class="status-btn del-btn" onclick="rejectWithdraw('${userId}', '${wId}')">Reject</button>
                            </td>
                        </tr>`;
                    }
                });
            });
        }

        window.approveWithdraw = async (uId, wId) => {
            if(confirm("Mark as Paid?")){
                await update(ref(db, `withdrawals/${uId}/${wId}`), { status: "Paid" });
                alert("Updated!");
                loadWithdraws();
            }
        };

        window.rejectWithdraw = async (uId, wId) => {
            if(confirm("Reject this request?")){
                await remove(ref(db, `withdrawals/${uId}/${wId}`));
                alert("Deleted!");
                loadWithdraws();
            }
        };

        loadUsers();
        loadWithdraws();
    </script>
</body>
</html>
